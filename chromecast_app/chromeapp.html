<html>
<head>
        <title>Chromecast Media Player</title>

<style>
/* Make the background color Non-black so see comments */
body{
        background-color: #ccf;
}

/* Hardcoded to my 720p TV */
video{
	width: 100%;
	height: 100%;
}

</style>

<script>


function ready(){
	// Hardcoded to my NAS server's static IP
	var WS_URL = "ws://192.168.0.200:50505";

	var connection = null;

	function check_ws_connection() {
		// If connection is undefined or closed
		if (connection == null || connection.readyState == 3){
			delete(connection);
			connection = new WebSocket(WS_URL,[]);
				connection.onopen = function () {
			};

			// Log errors
			connection.onerror = function (error) {
  				console.log('WebSocket Error ' + error);
			};

			// Log messages from the server
			connection.onmessage = function (e) {
				var obj = JSON.parse(e.data || "{}");
		
				console.log('Server: ' + obj["cmd"]);
				
				parse_command(obj);	
			};

			connection.onclose = function (e){
				console.log("Connection Closed");
			};
		}
	}


	function parse_command(obj){
		var video = document.getElementsByTagName("video")[0];
		switch(obj["cmd"]){
			case "play_pause":
				play_pause(video);
				break;
			case "skip":
				skip(video,obj);
				break;
			case "load":
				load(video,obj);
				break;
			default:
				get_status(video);
		}
	}

	function generic_response(){
		var obj = {};
		obj["source"] = "chromecast";
		obj["status"] = "OK";
		return obj;
	}

	function play_pause(video){
		if( video.paused){
			video.play();
			console.log("Play Video");
		} else {
			video.pause();
			console.log("Pause Video");

		}

		connection.send(JSON.stringify(generic_response()));
	}

	function skip(video,obj){
		video.currentTime = video.duration*obj["percent"]/100
		connection.send(JSON.stringify(generic_response()));
	}

	function get_status(video){
		var obj = {};
		obj["percent"] = video.currentTime/video.duration*100;
		obj["paused"] = video.paused;
		obj["src"] = video.currentSrc;
		connection.send(JSON.stringify(obj));
	}

	function load(video,obj){
		video.src = obj["src"];
		connection.send(JSON.stringify(generic_response()));
	}

	// Check the WebSocket Connection every 10 seconds
	setInterval(check_ws_connection,10000);
	check_ws_connection();
}


window.onload = ready();

</script>	
</head>
<body>
	<!-- Set Big Buck Bunny as default for development -->
	<video src="http://media.w3.org/2010/05/bunny/movie.mp4" autoplay ></video>


</body>
</html>

